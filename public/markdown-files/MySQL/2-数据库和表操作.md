# 数据库和表操作

### 1.SQL语法规则

#### 1.1基本规则
- **SQL语句以分号结束**：每个完整的SQL语句必须以分号(`;`)结束
- **关键字不区分大小写**：`SELECT`、`select`、`Select` 都是有效的
- **支持换行和缩进**：可以使用换行和缩进来提高SQL语句的可读性

#### 1.2 SQL注释
```sql
-- 这是单行注释
SELECT * FROM users; -- 行末注释

/* 
这是多行注释
可以跨越多行
*/
SELECT name, age FROM users;
```

### 2.数据库操作

#### 2.1SQL语法分类

##### DDL (Data Definition Language)
- **数据定义语言**，包含数据库对象操作
- 主要用于创建、修改、删除数据库结构
- 常用命令：`CREATE`、`ALTER`、`DROP`

##### DCL (Data Control Language)
- **数据控制语言**，控制用户和权限
- 主要用于授权和权限管理
- 常用命令：`GRANT`、`REVOKE`

##### DML (Data Manipulation Language)
- **数据操作语言**，包含数据插入、修改、删除
- 主要用于对表中数据的操作
- 常用命令：`INSERT`、`UPDATE`、`DELETE`

##### TCL (Transaction Control Language)
- **事务控制语言**，包含事务开启、提交、回滚
- 主要用于事务管理
- 常用命令：`BEGIN`、`COMMIT`、`ROLLBACK`

##### DQL (Data Query Language)
- **数据查询语言**，包含数据查询操作
- 主要用于从数据库中检索数据
- 常用命令：`SELECT`

#### 2.2 数据库操作详解

##### 概述
- **MySQL数据库属于多例数据库**：一个MySQL服务器可以管理多个数据库实例
- **Oracle数据库属于单例数据库**：一个Oracle服务器通常管理一个数据库实例

##### (1) 创建数据库
```sql
CREATE DATABASE [IF NOT EXISTS] 数据库名 [CHARACTER SET 字符编码];

-- 示例
CREATE DATABASE school;
CREATE DATABASE IF NOT EXISTS school CHARACTER SET utf8mb4;
```

##### (2) 使用数据库
```sql
USE 数据库名称;

-- 示例
USE school;
```

##### (3) 删除数据库
```sql
DROP DATABASE [IF EXISTS] 数据库名称;

-- 示例
DROP DATABASE school;
DROP DATABASE IF EXISTS school;
```

##### (4) 查询数据库
```sql
-- 查询正在使用的数据库
SELECT DATABASE();

-- 查询系统所有数据库
SHOW DATABASES;
```

### 2.MySQL数据类型

#### 2.1 数值类型

##### (1) 7大整数类型
| 类型 | 字节数 | 位数 | 取值范围(有符号) | 取值范围(无符号) |
|------|--------|------|------------------|------------------|
| `TINYINT` | 1字节 | 8位 | -128 ~ 127 | 0 ~ 255 |
| `SMALLINT` | 2字节 | 16位 | -32,768 ~ 32,767 | 0 ~ 65,535 |
| `MEDIUMINT` | 3字节 | 24位 | -8,388,608 ~ 8,388,607 | 0 ~ 16,777,215 |
| `INT/INTEGER` | 4字节 | 32位 | -2,147,483,648 ~ 2,147,483,647 | 0 ~ 4,294,967,295 |
| `BIGINT` | 8字节 | 64位 | -9,223,372,036,854,775,808 ~ 9,223,372,036,854,775,807 | 0 ~ 18,446,744,073,709,551,615 |
| `FLOAT` | 4字节 | 32位 | 单精度浮点数 | - |
| `DOUBLE` | 8字节 | 64位 | 双精度浮点数 | - |

#### (2) 符号位
- **SIGNED**：有符号位（默认）
- **UNSIGNED**：无符号位

```sql
-- 示例
CREATE TABLE example (
    id INT UNSIGNED,           -- 无符号整数
    age TINYINT,              -- 有符号小整数（默认）
    salary DECIMAL(10,2)      -- 定点数
);
```

#### 2.2 字符串类型

##### 基本规则
- **字符串使用单引号表示**：在SQL中，字符串值必须用单引号括起来

##### 常用数据类型

###### (1) CHAR类型
```sql
-- 固定长度字符串
CHAR(n)  -- n表示字符数，最大255

-- 示例
CREATE TABLE user_info (
    user_code CHAR(6),        -- 固定6位用户编码
    gender CHAR(1)            -- 性别：M/F
);
```

###### (2) VARCHAR类型
```sql
-- 可变长度字符串
VARCHAR(n)  -- n表示最大字符数，最大65535

-- 示例
CREATE TABLE user_profile (
    username VARCHAR(50),     -- 用户名，最大50字符
    email VARCHAR(100),       -- 邮箱地址
    description VARCHAR(500)  -- 个人描述
);
```

##### 其他字符串类型
- **TEXT**：文本类型，用于存储大量文本数据
- **BLOB**：二进制类型，用于存储二进制数据（如图片、文件等）

```sql
-- 示例
CREATE TABLE articles (
    id INT PRIMARY KEY,
    title VARCHAR(200),
    content TEXT,             -- 文章内容
    image BLOB               -- 图片数据
);
```

#### 2.3 日期时间类型

| 类型 | 格式 | 说明 |
|------|------|------|
| `YEAR` | YYYY | 年份，范围1901-2155 |
| `DATE` | YYYY-MM-DD | 日期，只有年月日 |
| `TIME` | HH:MM:SS | 时间，只有小时分钟秒 |
| `DATETIME` | YYYY-MM-DD HH:MM:SS | 包含年月日小时分钟秒 |
| `TIMESTAMP` | YYYY-MM-DD HH:MM:SS | 时间戳，自动更新 |

```sql
-- 示例
CREATE TABLE events (
    id INT PRIMARY KEY,
    event_name VARCHAR(100),
    event_year YEAR,          -- 活动年份
    event_date DATE,          -- 活动日期
    start_time TIME,          -- 开始时间
    created_at DATETIME,      -- 创建时间
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3. 表操作

#### 3.1 创建表

##### 基本语法
```sql
CREATE TABLE [IF NOT EXISTS] 表名 (
    字段名 数据类型 [约束] [COMMENT '描述']
);
```

##### 示例
```sql
CREATE TABLE IF NOT EXISTS students (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '学生ID',
    name VARCHAR(50) NOT NULL COMMENT '学生姓名',
    age TINYINT UNSIGNED COMMENT '年龄',
    email VARCHAR(100) UNIQUE COMMENT '邮箱地址',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) COMMENT '学生信息表';
```

#### 3.2 命名规范

- **使用小写字母**：表名和字段名都使用小写
- **下划线分割单词**：多个单词之间用下划线连接
- **避免使用关键字**：如果必须使用关键字，用反引号括起来

```sql
-- 良好的命名示例
CREATE TABLE user_profiles (
    user_id INT,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    birth_date DATE
);

-- 使用关键字的情况
CREATE TABLE `order` (
    `order_id` INT,
    `desc` VARCHAR(200)  -- desc是关键字，需要反引号
);
```

#### 3.3 查询表

##### (1) 查询当前数据库所有表
```sql
SHOW TABLES;
```

##### (2) 查询表结构
```sql
-- 方式一：使用DESCRIBE
DESCRIBE 表名;

-- 方式二：使用DESC（简写）
DESC 表名;

-- 示例
DESC students;
```

##### (3) 查询建表的SQL语句
```sql
SHOW CREATE TABLE 表名;

-- 示例
SHOW CREATE TABLE students;
```

#### 3.4 删除表

##### (1) 删除表
```sql
DROP TABLE [IF EXISTS] 表名;

-- 示例
DROP TABLE students;
DROP TABLE IF EXISTS students;
```
- **删除表数据**：清空所有数据
- **删除表存储空间**：释放磁盘空间
- **删除表结构**：表定义完全消失
- **无法回滚**：操作不可逆

##### (2) 清空表
```sql
TRUNCATE TABLE 表名;

-- 示例
TRUNCATE TABLE students;
```
- **删除表数据**：清空所有数据
- **删除表存储空间**：释放磁盘空间
- **保留表结构**：表定义保持不变
- **无法回滚**：操作不可逆
- **重置自增计数器**：AUTO_INCREMENT重新从1开始

#### 3.5 修改表

##### (1) 添加列
```sql
ALTER TABLE 表名 ADD 列名 数据类型 [约束] [COMMENT '描述'];

-- 示例
ALTER TABLE students ADD phone VARCHAR(20) COMMENT '手机号码';
ALTER TABLE students ADD address TEXT AFTER email; -- 在email字段后添加
```

##### (2) 修改列
```sql
ALTER TABLE 表名 MODIFY 列名 数据类型 [约束] [COMMENT '描述'];

-- 示例
ALTER TABLE students MODIFY name VARCHAR(100) NOT NULL COMMENT '学生姓名';
```

##### (3) 删除列
```sql
ALTER TABLE 表名 DROP 列名;

-- 示例
ALTER TABLE students DROP phone;
```

##### (4) 重命名列
```sql
ALTER TABLE 表名 RENAME COLUMN 旧列名 TO 新列名;

-- 示例
ALTER TABLE students RENAME COLUMN name TO student_name;
```

##### (5) 重命名表
```sql
ALTER TABLE 旧表名 RENAME TO 新表名;

-- 示例
ALTER TABLE students RENAME TO student_info;
```

##### 开发建议
- **尽量减少修改表结构操作**：频繁修改会影响性能
- **预留备用列**：为应对业务需求变更，可预留常用数据类型的备用列

```sql
-- 预留备用列的示例
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100),
    -- 预留备用列
    spare_varchar1 VARCHAR(100) COMMENT '备用字符串字段1',
    spare_varchar2 VARCHAR(100) COMMENT '备用字符串字段2',
    spare_int1 INT COMMENT '备用整数字段1',
    spare_datetime1 DATETIME COMMENT '备用日期时间字段1'
);
```

### 4. 约束

#### 4.1 约束概念

**约束**是对数据/字段的强制性要求，用于保证数据的完整性和一致性。

#### 4.2 常见约束

##### (1) 非空约束
```sql
-- NOT NULL：字段值不能为空
CREATE TABLE users (
    id INT NOT NULL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100)  -- 可以为空
);
```

##### (2) 默认值约束
```sql
-- DEFAULT：插入数据时如果为空，使用默认值
CREATE TABLE users (
    id INT,
    username VARCHAR(50),
    status TINYINT DEFAULT 1 COMMENT '状态：1-活跃，0-禁用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

##### (3) 唯一性约束
```sql
-- UNIQUE：字段值必须唯一
CREATE TABLE users (
    id INT,
    username VARCHAR(50) UNIQUE,
    email VARCHAR(100) UNIQUE
);
```

##### (4) 检查约束
```sql
-- CHECK：检查字段值是否满足条件
CREATE TABLE students (
    id INT,
    name VARCHAR(50),
    age TINYINT CHECK (age >= 0 AND age <= 150),
    gender CHAR(1) CHECK (gender IN ('M', 'F'))
);
```

##### (5) 主键约束
```sql
-- PRIMARY KEY：主键是数据的唯一标识
-- 特点：非空且唯一，一个表只能有一个主键

-- 单列主键
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50)
);

-- 联合主键：多列联合起来作为主键
CREATE TABLE order_items (
    order_id INT,
    product_id INT,
    quantity INT,
    PRIMARY KEY (order_id, product_id)
);
```

##### (6) 自增约束
```sql
-- AUTO_INCREMENT：MySQL特有语法，一般与主键一起使用
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50)
);
```

##### (7) 表级约束
```sql
-- 在表定义末尾定义约束
CREATE TABLE users (
    id INT,
    username VARCHAR(50),
    email VARCHAR(100),
    CONSTRAINT pk_users PRIMARY KEY (id),
    CONSTRAINT uk_username UNIQUE (username),
    CONSTRAINT uk_email UNIQUE (email)
);
```

##### (8) 外键约束
```sql
-- FOREIGN KEY：外键是数据与其他表关联的标识
-- 外键必须定义在表级

CREATE TABLE departments (
    dept_id INT PRIMARY KEY,
    dept_name VARCHAR(50)
);

CREATE TABLE employees (
    emp_id INT PRIMARY KEY,
    emp_name VARCHAR(50),
    dept_id INT,
    CONSTRAINT fk_emp_dept FOREIGN KEY (dept_id) REFERENCES departments(dept_id)
);
```

#### 4.3 级联操作

外键约束支持级联操作，用于维护数据的参照完整性：

```sql
CREATE TABLE employees (
    emp_id INT PRIMARY KEY,
    emp_name VARCHAR(50),
    dept_id INT,
    CONSTRAINT fk_emp_dept FOREIGN KEY (dept_id) 
    REFERENCES departments(dept_id)
    ON DELETE CASCADE          -- 删除级联
    ON UPDATE CASCADE          -- 更新级联
);
```

##### 级联操作类型
- **NO ACTION / RESTRICT**：默认行为，阻止删除/更新
- **CASCADE**：更新/删除主键时，外键表也会更新/删除
- **SET NULL**：更新/删除主键时，外键会置为NULL

```sql
-- 示例：不同的级联操作
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    product_id INT,
    -- 客户删除时，订单的customer_id设为NULL
    CONSTRAINT fk_order_customer FOREIGN KEY (customer_id) 
    REFERENCES customers(customer_id) ON DELETE SET NULL,
    -- 产品删除时，不允许删除（保护订单数据）
    CONSTRAINT fk_order_product FOREIGN KEY (product_id) 
    REFERENCES products(product_id) ON DELETE RESTRICT
);
```
